---
const repo = import.meta.env.PUBLIC_GISCUS_REPO ?? "KenXiao1/cn-nonsense";
const repoId = import.meta.env.PUBLIC_GISCUS_REPO_ID ?? "R_kgDORRXixQ";
const category = import.meta.env.PUBLIC_GISCUS_CATEGORY ?? "General";
const categoryId = import.meta.env.PUBLIC_GISCUS_CATEGORY_ID ?? "DIC_kwDORRXixc4C2nKd";
const mapping = import.meta.env.PUBLIC_GISCUS_MAPPING ?? "pathname";
const strict = import.meta.env.PUBLIC_GISCUS_STRICT ?? "0";
const reactionsEnabled = import.meta.env.PUBLIC_GISCUS_REACTIONS_ENABLED ?? "1";
const emitMetadata = import.meta.env.PUBLIC_GISCUS_EMIT_METADATA ?? "0";
const inputPosition = import.meta.env.PUBLIC_GISCUS_INPUT_POSITION ?? "top";
const theme = import.meta.env.PUBLIC_GISCUS_THEME ?? "preferred_color_scheme";
const lang = import.meta.env.PUBLIC_GISCUS_LANG ?? "zh-CN";
---

<section
  class="frame comments"
  id="giscus-comments"
  data-giscus-theme={theme}
  data-giscus-repo={repo}
  data-giscus-repo-id={repoId}
  data-giscus-category={category}
  data-giscus-category-id={categoryId}
  data-giscus-mapping={mapping}
  data-giscus-strict={strict}
  data-giscus-reactions-enabled={reactionsEnabled}
  data-giscus-emit-metadata={emitMetadata}
  data-giscus-input-position={inputPosition}
  data-giscus-lang={lang}
>
  <h2>章节评论</h2>
  {
    repoId && categoryId ? (
      <>
        <script>
          import { createGiscusThemeMessage, resolveGiscusTheme } from "../utils/giscus-theme.ts";

          (() => {
            const section = document.getElementById("giscus-comments");
            if (!(section instanceof HTMLElement)) {
              return;
            }

            const configuredTheme = section.dataset.giscusTheme ?? "preferred_color_scheme";
            const resolveThemeFromPage = () => {
              const isDark = document.documentElement.classList.contains("dark");
              return resolveGiscusTheme(configuredTheme, isDark);
            };

            const injectGiscusClient = () => {
              if (section.querySelector('script[data-giscus-client="true"]')) {
                return;
              }

              const repo = section.dataset.giscusRepo;
              const repoId = section.dataset.giscusRepoId;
              const category = section.dataset.giscusCategory;
              const categoryId = section.dataset.giscusCategoryId;
              if (!repo || !repoId || !category || !categoryId) {
                return;
              }

              const clientScript = document.createElement("script");
              clientScript.src = "https://giscus.app/client.js";
              clientScript.setAttribute("data-giscus-client", "true");
              clientScript.setAttribute("data-repo", repo);
              clientScript.setAttribute("data-repo-id", repoId);
              clientScript.setAttribute("data-category", category);
              clientScript.setAttribute("data-category-id", categoryId);
              clientScript.setAttribute("data-mapping", section.dataset.giscusMapping ?? "pathname");
              clientScript.setAttribute("data-strict", section.dataset.giscusStrict ?? "0");
              clientScript.setAttribute(
                "data-reactions-enabled",
                section.dataset.giscusReactionsEnabled ?? "1"
              );
              clientScript.setAttribute(
                "data-emit-metadata",
                section.dataset.giscusEmitMetadata ?? "0"
              );
              clientScript.setAttribute(
                "data-input-position",
                section.dataset.giscusInputPosition ?? "top"
              );
              clientScript.setAttribute("data-theme", resolveThemeFromPage());
              clientScript.setAttribute("data-lang", section.dataset.giscusLang ?? "zh-CN");
              clientScript.crossOrigin = "anonymous";
              clientScript.async = true;
              section.append(clientScript);
            };

            let activeFrame: HTMLIFrameElement | null = null;
            let isFrameReady = false;

            const syncGiscusTheme = () => {
              const frame = activeFrame;
              if (!(frame instanceof HTMLIFrameElement) || !frame.contentWindow || !isFrameReady) {
                return;
              }

              frame.contentWindow.postMessage(
                createGiscusThemeMessage(resolveThemeFromPage()),
                "https://giscus.app"
              );
            };

            const registerFrame = () => {
              const frame = section.querySelector("iframe.giscus-frame");
              if (!(frame instanceof HTMLIFrameElement) || frame === activeFrame) {
                return;
              }

              activeFrame = frame;
              isFrameReady = false;
              frame.addEventListener(
                "load",
                () => {
                  isFrameReady = true;
                  syncGiscusTheme();
                },
                { once: true }
              );
            };

            const htmlObserver = new MutationObserver((mutations) => {
              for (const mutation of mutations) {
                if (mutation.type === "attributes" && mutation.attributeName === "class") {
                  syncGiscusTheme();
                  break;
                }
              }
            });
            htmlObserver.observe(document.documentElement, {
              attributes: true,
              attributeFilter: ["class"]
            });

            const frameObserver = new MutationObserver(() => {
              registerFrame();
            });
            frameObserver.observe(section, { childList: true, subtree: true });

            injectGiscusClient();
            registerFrame();
          })();
        </script>
      </>
    ) : (
      <p class="setup-tip">
        尚未配置 giscus ID。请在环境变量中设置
        <code>PUBLIC_GISCUS_REPO_ID</code> 和 <code>PUBLIC_GISCUS_CATEGORY_ID</code>。
      </p>
    )
  }
</section>

<style>
  .comments {
    margin-top: 2rem;
  }

  .comments h2 {
    margin-top: 0;
    margin-bottom: 0.8rem;
    font-size: 1.3rem;
  }

  .setup-tip {
    margin: 0;
    color: var(--muted);
    line-height: 1.8;
  }

  code {
    font-family: "Cascadia Mono", "Consolas", monospace;
    background: rgba(186, 27, 29, 0.08);
    padding: 0.1rem 0.28rem;
    border-radius: 0.25rem;
  }
</style>
